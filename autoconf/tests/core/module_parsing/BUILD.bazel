load("@bazel_skylib//rules:write_file.bzl", "write_file")
load("//autoconf:autoconf_hdr.bzl", "autoconf_hdr")
load("//autoconf:package_info.bzl", "package_info")
load("//autoconf/tests:diff_test.bzl", "diff_test")

# Test case 1: Basic module definition with standard spacing
write_file(
    name = "module_basic",
    out = "module_basic.bazel",
    content = [
        "module(",
        '    name = "test_module",',
        '    version = "1.0.0",',
        ")",
    ],
)

package_info(
    name = "module_info_basic",
    module_bazel = ":module_basic.bazel",
)

autoconf_hdr(
    name = "config_basic",
    out = "config_basic.h",
    template = "config.h.in",
    deps = [":module_info_basic"],
)

# Test case 2: Module with no spaces around equals
write_file(
    name = "module_no_spaces",
    out = "module_no_spaces.bazel",
    content = [
        "module(",
        '    name="test_module",',
        '    version="1.0.0",',
        ")",
    ],
)

package_info(
    name = "module_info_no_spaces",
    module_bazel = ":module_no_spaces.bazel",
)

autoconf_hdr(
    name = "config_no_spaces",
    out = "config_no_spaces.h",
    template = "config.h.in",
    deps = [":module_info_no_spaces"],
)

# Test case 3: Module with extra whitespace
write_file(
    name = "module_extra_whitespace",
    out = "module_extra_whitespace.bazel",
    content = [
        "module(  ",
        '    name  =  "test_module"  ,',
        '    version  =  "1.0.0"  ,',
        "  )",
    ],
)

package_info(
    name = "module_info_extra_whitespace",
    module_bazel = ":module_extra_whitespace.bazel",
)

autoconf_hdr(
    name = "config_extra_whitespace",
    out = "config_extra_whitespace.h",
    template = "config.h.in",
    deps = [":module_info_extra_whitespace"],
)

# Test case 4: Module with single line format
write_file(
    name = "module_single_line",
    out = "module_single_line.bazel",
    content = [
        'module(name = "test_module", version = "1.0.0")',
    ],
)

package_info(
    name = "module_info_single_line",
    module_bazel = ":module_single_line.bazel",
)

autoconf_hdr(
    name = "config_single_line",
    out = "config_single_line.h",
    template = "config.h.in",
    deps = [":module_info_single_line"],
)

# Test case 5: Module with comments and other content
write_file(
    name = "module_with_comments",
    out = "module_with_comments.bazel",
    content = [
        '"""Test module"""',
        "",
        "module(",
        '    name = "test_module",',
        '    version = "1.0.0",',
        ")",
        "",
        'bazel_dep(name = "rules_cc", version = "0.2.4")',
    ],
)

package_info(
    name = "module_info_with_comments",
    module_bazel = ":module_with_comments.bazel",
)

autoconf_hdr(
    name = "config_with_comments",
    out = "config_with_comments.h",
    template = "config.h.in",
    deps = [":module_info_with_comments"],
)

# Test case 6: Module with version containing special characters (should be escaped in JSON)
# This test uses a different version to test JSON escaping
write_file(
    name = "module_special_chars",
    out = "module_special_chars.bazel",
    content = [
        "module(",
        '    name = "test_module",',
        '    version = "1.0.0-beta.1",',
        ")",
    ],
)

package_info(
    name = "module_info_special_chars",
    module_bazel = ":module_special_chars.bazel",
)

autoconf_hdr(
    name = "config_special_chars",
    out = "config_special_chars.h",
    template = "config.h.in",
    deps = [":module_info_special_chars"],
)

# Golden file for special chars test (different version)
write_file(
    name = "golden_module_info_special_chars",
    out = "golden_module_info_special_chars.json",
    content = [
        "{",
        '    "name": "test_module",',
        '    "version": "1.0.0-beta.1"',
        "}",
    ],
)

# Golden header file for special chars test
write_file(
    name = "golden_config_special_chars",
    out = "golden_config_special_chars.h.in",
    content = [
        "/* config.h.in.  Generated from MODULE.bazel.  */",
        "",
        "/* Define to the full name of this package. */",
        '#define PACKAGE_NAME "test_module"',
        "",
        "/* Define to the version of this package. */",
        '#define PACKAGE_VERSION "1.0.0-beta.1"',
        "",
    ],
    newline = "unix",
)

# Test case 7: Module with nested parentheses (other bazel_dep calls)
write_file(
    name = "module_nested",
    out = "module_nested.bazel",
    content = [
        "module(",
        '    name = "test_module",',
        '    version = "1.0.0",',
        ")",
        "",
        'bazel_dep(name = "rules_cc", version = "0.2.4")',
        'bazel_dep(name = "platforms", version = "1.0.0")',
    ],
)

package_info(
    name = "module_info_nested",
    module_bazel = ":module_nested.bazel",
)

autoconf_hdr(
    name = "config_nested",
    out = "config_nested.h",
    template = "config.h.in",
    deps = [":module_info_nested"],
)

# Golden file - all test cases should produce the same output
# (same name and version, just different syntax)
write_file(
    name = "golden_module_info",
    out = "golden_module_info.json",
    content = [
        "{",
        '    "name": "test_module",',
        '    "version": "1.0.0"',
        "}",
    ],
)

# Diff tests for generated header files - all should match the golden header file
diff_test(
    name = "diff_test_header_basic",
    file1 = "golden_config.h.in",
    file2 = ":config_basic.h",
)

diff_test(
    name = "diff_test_header_no_spaces",
    file1 = "golden_config.h.in",
    file2 = ":config_no_spaces.h",
)

diff_test(
    name = "diff_test_header_extra_whitespace",
    file1 = "golden_config.h.in",
    file2 = ":config_extra_whitespace.h",
)

diff_test(
    name = "diff_test_header_single_line",
    file1 = "golden_config.h.in",
    file2 = ":config_single_line.h",
)

diff_test(
    name = "diff_test_header_with_comments",
    file1 = "golden_config.h.in",
    file2 = ":config_with_comments.h",
)

diff_test(
    name = "diff_test_header_special_chars",
    file1 = ":golden_config_special_chars.h.in",
    file2 = ":config_special_chars.h",
)

diff_test(
    name = "diff_test_header_nested",
    file1 = "golden_config.h.in",
    file2 = ":config_nested.h",
)

# Test case 8: Module with explicit name override
write_file(
    name = "module_with_forced_name",
    out = "module_with_forced_name.bazel",
    content = [
        "module(",
        '    name = "original_module",',
        '    version = "2.0.0",',
        ")",
    ],
)

package_info(
    name = "module_info_with_forced_name",
    package_name = "forced_module_name",
    module_bazel = ":module_with_forced_name.bazel",
)

autoconf_hdr(
    name = "config_with_forced_name",
    out = "config_with_forced_name.h",
    template = "config.h.in",
    deps = [":module_info_with_forced_name"],
)

# Golden header file for forced name test (should use forced name, original version)
write_file(
    name = "golden_config_with_forced_name",
    out = "golden_config_with_forced_name.h.in",
    content = [
        "/* config.h.in.  Generated from MODULE.bazel.  */",
        "",
        "/* Define to the full name of this package. */",
        '#define PACKAGE_NAME "forced_module_name"',
        "",
        "/* Define to the version of this package. */",
        '#define PACKAGE_VERSION "2.0.0"',
        "",
    ],
    newline = "unix",
)

# Test case 9: Module with explicit version override
write_file(
    name = "module_with_forced_version",
    out = "module_with_forced_version.bazel",
    content = [
        "module(",
        '    name = "original_module",',
        '    version = "1.0.0",',
        ")",
    ],
)

package_info(
    name = "module_info_with_forced_version",
    module_bazel = ":module_with_forced_version.bazel",
    package_version = "9.9.9",
)

autoconf_hdr(
    name = "config_with_forced_version",
    out = "config_with_forced_version.h",
    template = "config.h.in",
    deps = [":module_info_with_forced_version"],
)

# Golden header file for forced version test (should use original name, forced version)
write_file(
    name = "golden_config_with_forced_version",
    out = "golden_config_with_forced_version.h.in",
    content = [
        "/* config.h.in.  Generated from MODULE.bazel.  */",
        "",
        "/* Define to the full name of this package. */",
        '#define PACKAGE_NAME "original_module"',
        "",
        "/* Define to the version of this package. */",
        '#define PACKAGE_VERSION "9.9.9"',
        "",
    ],
    newline = "unix",
)

# Test case 10: Module with both explicit name and version override
write_file(
    name = "module_with_forced_name_and_version",
    out = "module_with_forced_name_and_version.bazel",
    content = [
        "module(",
        '    name = "original_module",',
        '    version = "1.0.0",',
        ")",
    ],
)

package_info(
    name = "module_info_with_forced_name_and_version",
    package_name = "custom_package",
    module_bazel = ":module_with_forced_name_and_version.bazel",
    package_version = "3.14.0",
)

autoconf_hdr(
    name = "config_with_forced_name_and_version",
    out = "config_with_forced_name_and_version.h",
    template = "config.h.in",
    deps = [":module_info_with_forced_name_and_version"],
)

# Golden header file for forced name and version test (should use both forced values)
write_file(
    name = "golden_config_with_forced_name_and_version",
    out = "golden_config_with_forced_name_and_version.h.in",
    content = [
        "/* config.h.in.  Generated from MODULE.bazel.  */",
        "",
        "/* Define to the full name of this package. */",
        '#define PACKAGE_NAME "custom_package"',
        "",
        "/* Define to the version of this package. */",
        '#define PACKAGE_VERSION "3.14.0"',
        "",
    ],
    newline = "unix",
)

# Test case 11: Module with forced name and version where forced values differ significantly
write_file(
    name = "module_with_different_forced_values",
    out = "module_with_different_forced_values.bazel",
    content = [
        "module(",
        '    name = "test_module",',
        '    version = "1.0.0",',
        ")",
    ],
)

package_info(
    name = "module_info_with_different_forced_values",
    package_name = "overridden_name",
    module_bazel = ":module_with_different_forced_values.bazel",
    package_version = "999.888.777",
)

autoconf_hdr(
    name = "config_with_different_forced_values",
    out = "config_with_different_forced_values.h",
    template = "config.h.in",
    deps = [":module_info_with_different_forced_values"],
)

# Golden header file for different forced values test
write_file(
    name = "golden_config_with_different_forced_values",
    out = "golden_config_with_different_forced_values.h.in",
    content = [
        "/* config.h.in.  Generated from MODULE.bazel.  */",
        "",
        "/* Define to the full name of this package. */",
        '#define PACKAGE_NAME "overridden_name"',
        "",
        "/* Define to the version of this package. */",
        '#define PACKAGE_VERSION "999.888.777"',
        "",
    ],
    newline = "unix",
)

# Diff tests for forced value test cases
diff_test(
    name = "diff_test_header_with_forced_name",
    file1 = ":golden_config_with_forced_name.h.in",
    file2 = ":config_with_forced_name.h",
)

diff_test(
    name = "diff_test_header_with_forced_version",
    file1 = ":golden_config_with_forced_version.h.in",
    file2 = ":config_with_forced_version.h",
)

diff_test(
    name = "diff_test_header_with_forced_name_and_version",
    file1 = ":golden_config_with_forced_name_and_version.h.in",
    file2 = ":config_with_forced_name_and_version.h",
)

diff_test(
    name = "diff_test_header_with_different_forced_values",
    file1 = ":golden_config_with_different_forced_values.h.in",
    file2 = ":config_with_different_forced_values.h",
)
