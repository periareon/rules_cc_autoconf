load("@rules_cc//cc:cc_test.bzl", "cc_test")
load("//autoconf:autoconf.bzl", "autoconf")
load("//autoconf:autoconf_hdr.bzl", "autoconf_hdr")
load("//autoconf:checks.bzl", "checks")
load("//autoconf:package_info.bzl", "package_info")
load("//autoconf/tests:diff_test.bzl", "diff_test")

package_info(
    name = "package",
    package_name = "test_mode_filtering",
    package_version = "1.0.0",
)

# Test autoconf with both AC_DEFINE (defines) and AC_SUBST (substitution variables)
autoconf(
    name = "autoconf",
    checks = [
        # AC_DEFINE creates defines that should appear in config.h
        checks.AC_DEFINE("HAVE_FEATURE", 1),
        checks.AC_CHECK_HEADER(
            "stdio.h",
            define = "HAVE_STDIO_H",
        ),
        # AC_SUBST creates substitution variables that should NOT appear in config.h
        # when mode="defines", but SHOULD appear in subst.h when mode="subst"
        checks.AC_SUBST("SUBST_VAR", "value"),
        checks.AC_SUBST("ANOTHER_SUBST", 42),
    ],
    deps = [":package"],
)

# config.h with mode="defines" (default) - should only have defines, NOT subst variables
autoconf_hdr(
    name = "config",
    out = "config.h",
    mode = "defines",  # Explicit, though it's the default
    template = "config.h.in",
    deps = [":autoconf"],
)

# subst.h with mode="subst" - should only have subst variables, NOT defines
autoconf_hdr(
    name = "subst",
    out = "subst.h",
    mode = "subst",
    template = "subst.h.in",
    deps = [":autoconf"],
)

diff_test(
    name = "diff_test_config",
    file1 = "golden_config.h.in",
    file2 = ":config.h",
)

diff_test(
    name = "diff_test_subst",
    file1 = "golden_subst.h.in",
    file2 = ":subst.h",
)

cc_test(
    name = "test_mode_filtering",
    srcs = [
        "test_mode_filtering.c",
        ":config.h",
    ],
)
