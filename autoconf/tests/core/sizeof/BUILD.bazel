load("@rules_cc//cc:cc_test.bzl", "cc_test")
load("//autoconf:autoconf.bzl", "autoconf")
load("//autoconf:autoconf_hdr.bzl", "autoconf_hdr")
load("//autoconf:checks.bzl", "checks")
load("//autoconf:package_info.bzl", "package_info")

package_info(
    name = "package",
    package_name = "test_sizeof",
    package_version = "1.0.0",
)

autoconf(
    name = "autoconf",
    checks = [
        checks.AC_CHECK_SIZEOF(
            "char",
            define = "SIZEOF_CHAR",
        ),
        checks.AC_CHECK_SIZEOF(
            "short",
            define = "SIZEOF_SHORT",
        ),
        checks.AC_CHECK_SIZEOF(
            "int",
            define = "SIZEOF_INT",
        ),
        checks.AC_CHECK_SIZEOF(
            "long",
            define = "SIZEOF_LONG",
        ),
        checks.AC_CHECK_SIZEOF(
            "void*",
            define = "SIZEOF_VOIDP",
        ),
    ],
    deps = [":package"],
)

autoconf_hdr(
    name = "config",
    out = "config.h",
    template = "config.h.in",
    deps = [":autoconf"],
)

# Note: sizeof values are platform-dependent, so we only run cc_test
cc_test(
    name = "test_sizeof",
    srcs = [
        "test_sizeof.c",
        ":config.h",
    ],
)
