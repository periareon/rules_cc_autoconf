load("@rules_cc//cc:cc_test.bzl", "cc_test")
load("//autoconf:autoconf.bzl", "autoconf")
load("//autoconf:autoconf_hdr.bzl", "autoconf_hdr")
load("//autoconf:macros.bzl", "macros")
load("//autoconf:package_info.bzl", "package_info")

filegroup(
    name = "test_compile_source",
    srcs = ["test_compile.c"],
)

filegroup(
    name = "test_type_source",
    srcs = ["test_type.c"],
)

package_info(
    name = "package",
    package_name = "test_file_based",
    package_version = "1.0.0",
)

autoconf(
    name = "autoconf",
    checks = [
        # Test AC_TRY_COMPILE with file parameter
        macros.AC_TRY_COMPILE(
            define = "FILE_COMPILE_WORKS",
            file = ":test_compile_source",
            language = "c",
        ),
        # Test AC_CHECK_TYPE with file parameter
        macros.AC_CHECK_TYPE(
            "int64_t",
            define = "HAVE_INT64_T",
            file = ":test_type_source",
            language = "c",
        ),
    ],
    data = [
        ":test_compile_source",
        ":test_type_source",
    ],
    deps = [":package"],
)

autoconf_hdr(
    name = "config",
    out = "config.h",
    template = "config.h.in",
    deps = [":autoconf"],
)

cc_test(
    name = "test_file_based",
    srcs = [
        "test_file_based.c",
        ":config.h",
    ],
)
