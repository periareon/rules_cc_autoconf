load("@rules_cc//cc:cc_test.bzl", "cc_test")
load("//autoconf:autoconf.bzl", "autoconf")
load("//autoconf:autoconf_hdr.bzl", "autoconf_hdr")
load("//autoconf:macros.bzl", "macros")
load("//autoconf:package_info.bzl", "package_info")
load("//autoconf/private/tests:diff_test.bzl", "diff_test")

package_info(
    name = "package_info",
    package_name = "test_gnulib_templates",
    package_version = "2.3.4",
)

autoconf(
    name = "autoconf",
    checks = [
        macros.AC_CHECK_HEADER("stdio.h"),
        macros.AC_CHECK_HEADER("stdlib.h"),
        macros.AC_DEFINE("SPECIAL_DEFINE"),
    ],
    deps = [":package_info"],
)

autoconf_hdr(
    name = "config",
    out = "config.h",
    inlines = {
        "/* @INCLUDE_GNULIB_FOOTER@ */": ":gnulib_footer.h.in",
        "/* @INCLUDE_GNULIB_HEADER@ */": ":gnulib_header.h.in",
    },
    template = "config.h.in",
    deps = [":autoconf"],
)

diff_test(
    name = "diff_test",
    file1 = "golden_config.h.in",
    file2 = ":config.h",
)

cc_test(
    name = "test_gnulib_templates",
    srcs = [
        "test_gnulib_templates.c",
        ":config.h",
    ],
)
